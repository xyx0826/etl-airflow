metadata:
  name: Certificates of Compliance
  description: Properties that have been issued a certificate of compliance by BSEED
  timeframe: 
views:
  ago:
    destination: ago
    id: 
    export: shapefile
    select: select
              per."B1_ALT_ID" as record_id,
              regexp_replace(concat_ws(' ', addr."B1_HSE_NBR_START", addr."B1_STR_DIR", addr."B1_STR_NAME", addr."B1_STR_SUFFIX"), '\s{1,}', ' ') as address,
              p."B1_PARCEL_NBR" as parcel_number,
              addr."B1_SITUS_ZIP" as zip,
							per."B1_APPL_STATUS" as status, # should just read "Issued", but this field seems useful too
							g."SD_PRO_DES" as task,
              to_date(per."REC_DATE", 'dd-MON-YY') as date_status
            FROM accela.b1permit per
              LEFT OUTER JOIN accela.b3addres addr ON per."B1_PER_ID1" = addr."B1_PER_ID1" 
                AND per."B1_PER_ID3" = addr."B1_PER_ID3"
              LEFT OUTER JOIN accela.b3parcel p ON per."B1_PER_ID1" = p."B1_PER_ID1" 
                AND per."B1_PER_ID3" = p."B1_PER_ID3"
              LEFT OUTER JOIN accela.gprocess g ON per."B1_PER_ID1" = g."B1_PER_ID1" 
                AND per."B1_PER_ID3" = g."B1_PER_ID3"
              LEFT OUTER JOIN b3owners own ON own."B1_PER_ID1" = per."B1_PER_ID1" 
                AND own."B1_PER_ID3" = per."B1_PER_ID3"
            WHERE g."SD_PRO_DES" = 'Issue CofC'
							AND addr."B1_PRIMARY_ADDR_FLG" = 'Y'
              and p."B1_PRIMARY_PAR_FLG" = 'Y'
              AND to_date(per."REC_DATE", 'dd-MON-YY') > date '2018-12-07'
